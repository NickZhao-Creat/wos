GAS LISTING kernel.s 			page 1


   1              		.text
   2              		.global startup_32
   3              		.global default_int
   4              		.include "kernel.h"
   1              	#define KERNEL_CODE_TYPE        0x9a
   2              	#define KERNEL_DATA_TYPE        0x92
   3              	#define USER_CODE_TYPE          0xfa
   4              	#define USER_DATA_TYPE          0xf2
   5              	#define VIDEO_TYPE              KERNEL_DATA_TYPE
   6              	
   7              	#define DESC_DEFAULT_TYPE       0xc
   8              	
   9              	#define KERNEL_CODE_DESC        0x2
  10              	#define KERNEL_DATA_DESC        0x3
  11              	#define USER_CODE_DESC          0x4
  12              	#define USER_DATA_DESC          0x5
  13              	#define VIDEO_DESC              0x6
  14              	
  15              	#define CODE_LIMIT              0xffffffff
  16              	#define DATA_LIMIT              CODE_LIMIT
  17              	
  18              	#define CODE_BASE               0x0
  19              	#define DATA_BASE               CODE_BASE
  20              	
  21              	#define VIDEO_LIMIT             0xffff
  22              	#define VIDEO_BASE              0xb8000
  23              	
  24              	.set CODE_SEL, 0x08	# code segment selector in kernel mode 
  25              	.set DATA_SEL, 0x10 # data segment selector in kernel mode
  26              	.set IDT_ADDR, 0x80000	# IDT start address
  27              	.set IDT_SIZE, (256*8)	# IDT has fixed length
  28              	.set GDT_ADDR, (IDT_ADDR+IDT_SIZE)
  29              				# GDT starts after IDT
  30              	.set GDT_ENTRIES, 5	# GDT has 5 descriptors
  31              				# null descriptor
  32              				# cs segment descriptor for kernel
  33              				# ds segment descriptor for kernel
  34              				# current process tss
  35              				# current process ldt
  36              	.set GDT_SIZE, (8*GDT_ENTRIES)
  37              				# GDT length
  38              	.set KERNEL_SECT, 72	# Kernel lenght, counted by sectors
   5              		.include "gdt.h"
   1              	#ifndef GDT_H
   2              	#define GDT_H
   3              	
   4              	#define KERNEL_CODE_TYPE        0x9a
   5              	#define KERNEL_DATA_TYPE        0x92
   6              	#define VIDEO_TYPE              KERNEL_DATA_TYPE
   7              	
   8              	#define DESC_DEFAULT_TYPE       0xc
   9              	
  10              	#define KERNEL_CODE_DESC        0x1
  11              	#define KERNEL_DATA_DESC        0x2
  12              	#define VIDEO_DESC              0x3
  13              	
  14              	#define CODE_LIMIT              0xffffffff
GAS LISTING kernel.s 			page 2


  15              	#define DATA_LIMIT              CODE_LIMIT
  16              	
  17              	#define CODE_BASE               0x0
  18              	#define DATA_BASE               CODE_BASE
  19              	
  20              	#define VIDEO_LIMIT             0xffff
  21              	#define VIDEO_BASE              0xb8000
  22              	
  23              	#define KERNEL_CODE_SEL		0x08	/* 01000 */
  24              	#define KERNEL_DATA_SEL		0x10	/* 10000 */
  25              	
  26              	#endif
   6              		.org 0
   7              	startup_32:
   8 0000 B8100000 		movl $0x10, %eax
   8      00
   9 0005 8ED8     		movw %ax, %ds
  10 0007 8EC0     		movw %ax, %es
  11 0009 8EE0     		movw %ax, %fs
  12 000b 8ED0     		movw %ax, %ss
  13 000d BC660200 		movl $init_stack, %esp
  13      00
  14              	
  15 0012 FC       		cld
  16 0013 BE000201 		movl $0x10200, %esi
  16      00
  17 0018 BF000200 		movl $0x200, %edi
  17      00
  18 001d B9802300 		movl $(KERNEL_SECT - 1) << 7, %ecx
  18      00
  19 0022 F3       		rep
  20 0023 A5       		movsl
  21              	
  22 0024 E8FCFFFF 		call setup_gdt
  22      FF
  23 0029 E8FCFFFF 		call setup_idt
  23      FF
  24 002e 0F011558 		lgdt new_gdt48
  24      000000
  25 0035 0F011D60 		lidt new_idt48
  25      000000
  26              	
  27 003c B8100000 		movl $0x10, %eax
  27      00
  28 0041 8ED8     		mov %ax, %ds
  29 0043 8EC0     		mov %ax, %es
  30 0045 8EE0     		mov %ax, %fs
  31 0047 8EE8     		mov %ax, %gs
  32 0049 BC660200 		movl $init_stack, %esp
  32      00
  33              	
  34 004e FB       		sti
  35 004f E8FCFFFF 		call kernel_init
  35      FF
  36              	
  37 0054 8D742600 	.align 8
  38              	new_gdt48:
GAS LISTING kernel.s 			page 3


  39 0058 FF00     	        .word 0xff
  40 005a 00000000 	        .long new_gdt
  41              	
  42 005e 6690     	.align 8
  43              	new_idt48:
  44 0060 FF00     		.word 0xff
  45 0062 00000000 		.long new_idt
  46              	
  47 0066 00000000 		.fill 128,4,0
  47      00000000 
  47      00000000 
  47      00000000 
  47      00000000 
  48              	init_stack:
  49 0266 6602     		.word init_stack
  50              	ring0_msg:
  51 0268 57652061 		.asciz "We are in Protect mode."
  51      72652069 
  51      6E205072 
  51      6F746563 
  51      74206D6F 
GAS LISTING kernel.s 			page 4


DEFINED SYMBOLS
            kernel.s:7      .text:0000000000000000 startup_32
            kernel.h:24     *ABS*:0000000000000008 CODE_SEL
            kernel.h:25     *ABS*:0000000000000010 DATA_SEL
            kernel.h:26     *ABS*:0000000000080000 IDT_ADDR
            kernel.h:27     *ABS*:0000000000000800 IDT_SIZE
            kernel.h:28     *ABS*:0000000000080800 GDT_ADDR
            kernel.h:30     *ABS*:0000000000000005 GDT_ENTRIES
            kernel.h:36     *ABS*:0000000000000028 GDT_SIZE
            kernel.h:38     *ABS*:0000000000000048 KERNEL_SECT
            kernel.s:48     .text:0000000000000266 init_stack
            kernel.s:38     .text:0000000000000058 new_gdt48
            kernel.s:43     .text:0000000000000060 new_idt48
            kernel.s:50     .text:0000000000000268 ring0_msg

UNDEFINED SYMBOLS
default_int
setup_gdt
setup_idt
kernel_init
new_gdt
new_idt
