GAS LISTING system_call.s 			page 1


   1              	.globl system_call
   2              	.align 2
   3              	
   4              	nr_system_calls = 2
   5              	
   6              	.macro SAVE_ALL
   7              	        push %fs
   8              	        push %es
   9              	        push %ds
  10              	        pushl %eax
  11              	        pushl %ebp
  12              	        pushl %edi
  13              	        pushl %esi
  14              	        pushl %edx
  15              	        pushl %ecx
  16              	        pushl %ebx
  17              	.endm
  18              	
  19              	.macro RESTORE_ALL
  20              	        popl %ebx
  21              	        popl %ecx
  22              	        popl %edx
  23              	        popl %esi
  24              	        popl %edi
  25              	        popl %ebp
  26              	        popl %eax
  27              	        pop %ds
  28              	        pop %es
  29              		pop %fs
  30              	.endm
  31              	      
  32              	.align 2
  33              	reschedule:
  34 0000 683D0000 		pushl $ret_from_sys_call
  34      00
  35 0005 E9FCFFFF 		jmp schedule
  35      FF
  36              	
  37              	.align 2
  38              	system_call:
  39 000a 83F801   		cmpl $nr_system_calls - 1, %eax
  40 000d 773D     		ja bad_sys_call
  41 000f 6A00     		pushl $0
  42 0011 0FA0061E 		SAVE_ALL
  42      50555756 
  42      525153
  43 001c 50       		pushl %eax
  44 001d 66B81000 		movw $0x10, %ax
  45 0021 8ED8     		movw %ax, %ds
  46 0023 8EC0     		movw %ax, %es
  47 0025 8EE0     		movw %ax, %fs
  48 0027 58       		popl %eax
  49 0028 FF14855C 		call sys_call_table(, %eax, 4)
****  Warning:indirect call without `*'
  49      000000
  50 002f A1000000 		movl current, %eax
  50      00
GAS LISTING system_call.s 			page 2


  51 0034 83B89600 		cmpl $0, 150(%eax)
  51      000000
  52 003b 74C3     		je reschedule
  53              	ret_from_sys_call:
  54 003d 5B595A5E 		RESTORE_ALL
  54      5F5D581F 
  54      070FA1
  55 0048 83C404   		addl $4, %esp
  56 004b CF       		iret
  57              	
  58              	bad_sys_call:
  59 004c B8FFFFFF 		movl $-1, %eax
  59      FF
  60 0051 CF       		iret
  61              	
  62              	sys_fork:
  63 0052 54       		pushl %esp
  64 0053 E8FCFFFF 		call do_fork
  64      FF
  65 0058 83C404   		addl $4, %esp
  66 005b C3       		ret
  67              	
  68              	sys_call_table:
  69 005c 00000000 		.long sys_write
  70 0060 52000000 		.long sys_fork
  71 0064 00000000 		.long 0
  72              	
  73              	test_msg:
  74 0068 696E2073 		.asciz "in system call."
  74      79737465 
  74      6D206361 
  74      6C6C2E00 
GAS LISTING system_call.s 			page 3


DEFINED SYMBOLS
       system_call.s:38     .text:000000000000000a system_call
       system_call.s:4      *ABS*:0000000000000002 nr_system_calls
       system_call.s:33     .text:0000000000000000 reschedule
       system_call.s:53     .text:000000000000003d ret_from_sys_call
       system_call.s:58     .text:000000000000004c bad_sys_call
       system_call.s:68     .text:000000000000005c sys_call_table
       system_call.s:62     .text:0000000000000052 sys_fork
       system_call.s:73     .text:0000000000000068 test_msg

UNDEFINED SYMBOLS
schedule
current
do_fork
sys_write
